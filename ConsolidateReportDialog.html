<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
      }
      .header {
        text-align: center;
        margin-bottom: 20px;
        font-weight: bold;
        font-size: 16px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .checkbox-list {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
      }
      .workshop-item {
        margin-bottom: 8px;
      }
      .button-group {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
      }
      .btn {
        background-color: #4285f4;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 4px;
        font-weight: bold;
        flex-grow: 1;
        margin: 0 5px;
      }
      .btn:first-child {
        margin-left: 0;
      }
      .btn:last-child {
        margin-right: 0;
      }
      .btn:hover {
        background-color: #2a75f3;
      }
      .checkbox-container {
        display: flex;
        align-items: center;
        margin: 5px 0;
      }
      .checkbox-container input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
      }
      .checkbox-container label {
        display: inline;
        font-weight: normal;
      }
      .progress-container {
        margin-top: 20px;
        display: none;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #f3f3f3;
        border-radius: 4px;
        margin-top: 5px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background-color: #4285f4;
        width: 0%;
        transition: width 0.3s ease;
      }
      .status-message {
        margin-top: 10px;
        font-weight: bold;
      }
      .hidden {
        display: none;
      }
      .action-buttons {
        margin: 10px 0;
      }
      .action-buttons button {
        background-color: #f1f1f1;
        color: #333;
        border: 1px solid #ddd;
        padding: 5px 10px;
        margin-right: 5px;
        cursor: pointer;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      TỔNG HỢP BÁO CÁO TỪ CÁC PHÂN XƯỞNG
    </div>
    
    <form id="reportForm">
      <div class="form-group">
        <label for="monthSelect">Chọn tháng/năm báo cáo:</label>
        <select id="monthSelect">
          <option value="">-- Chọn tháng/năm --</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Chọn phân xưởng:</label>
        <div class="action-buttons">
          <button type="button" onclick="selectAll(true)">Chọn tất cả</button>
          <button type="button" onclick="selectAll(false)">Bỏ chọn tất cả</button>
        </div>
        <div id="workshopList" class="checkbox-list">
          <div class="loading">Đang tải danh sách phân xưởng...</div>
        </div>
      </div>
      
      <button type="button" class="btn" id="consolidateBtn">Tổng hợp báo cáo</button>
    </form>
    
    <div id="progressContainer" class="progress-container">
      <div class="status-message" id="statusMessage">Đang xử lý...</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
    
    <script>
      // Biến toàn cục
      let availableMonths = [];
      let workshopsWithReport = [];
      
      // Khi trang được tải
      document.addEventListener('DOMContentLoaded', function() {
        // Lấy danh sách tháng có sẵn
        google.script.run
          .withSuccessHandler(onMonthsLoaded)
          .withFailureHandler(onError)
          .getAvailableMonths();
        
        // Gán sự kiện cho nút tổng hợp
        document.getElementById('consolidateBtn').addEventListener('click', consolidateReports);
        
        // Gán sự kiện cho combobox tháng
        document.getElementById('monthSelect').addEventListener('change', onMonthSelected);
      });
      
      // Xử lý sau khi tải danh sách tháng
      function onMonthsLoaded(months) {
        availableMonths = months;
        const select = document.getElementById('monthSelect');
        
        // Thêm các tháng vào dropdown
        months.forEach(function(month) {
          const option = document.createElement('option');
          option.value = month;
          option.textContent = month;
          select.appendChild(option);
        });
        
        // Chọn tháng mới nhất
        if (months.length > 0) {
          select.value = months[months.length - 1];
          onMonthSelected();
        }
      }
      
      // Xử lý khi chọn tháng
      function onMonthSelected() {
        const monthSelect = document.getElementById('monthSelect');
        const selectedMonth = monthSelect.value;
        
        if (selectedMonth) {
          // Hiển thị thông báo đang tải
          document.getElementById('workshopList').innerHTML = '<div class="loading">Đang tải danh sách phân xưởng...</div>';
          
          // Lấy danh sách phân xưởng có báo cáo cho tháng đã chọn
          google.script.run
            .withSuccessHandler(onWorkshopsLoaded)
            .withFailureHandler(onError)
            .getWorkshopsWithReport(selectedMonth);
        } else {
          document.getElementById('workshopList').innerHTML = '<div>Vui lòng chọn tháng/năm báo cáo</div>';
        }
      }
      
      // Xử lý sau khi tải danh sách phân xưởng
      function onWorkshopsLoaded(workshops) {
        workshopsWithReport = workshops;
        renderWorkshopList();
      }
      
      // Hiển thị danh sách phân xưởng
      function renderWorkshopList() {
        const container = document.getElementById('workshopList');
        container.innerHTML = '';
        
        if (!workshopsWithReport || workshopsWithReport.length === 0) {
          container.innerHTML = '<div>Không có phân xưởng nào có báo cáo cho tháng đã chọn</div>';
          return;
        }
        
        // Hiển thị danh sách phân xưởng
        workshopsWithReport.forEach(function(workshop) {
          const workshopItem = document.createElement('div');
          workshopItem.className = 'workshop-item';
          
          const checkboxContainer = document.createElement('div');
          checkboxContainer.className = 'checkbox-container';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = 'workshop_' + workshop.code;
          checkbox.value = workshop.code;
          checkbox.name = 'workshops';
          checkbox.checked = true; // Mặc định chọn tất cả
          
          const label = document.createElement('label');
          label.htmlFor = 'workshop_' + workshop.code;
          label.textContent = workshop.name + ' (' + workshop.code + ')';
          
          checkboxContainer.appendChild(checkbox);
          checkboxContainer.appendChild(label);
          workshopItem.appendChild(checkboxContainer);
          
          container.appendChild(workshopItem);
        });
      }
      
      // Chọn/bỏ chọn tất cả phân xưởng
      function selectAll(select) {
        const checkboxes = document.querySelectorAll('input[name="workshops"]');
        checkboxes.forEach(function(checkbox) {
          checkbox.checked = select;
        });
      }
      
      // Tổng hợp báo cáo
      function consolidateReports() {
        // Hiển thị thanh tiến trình
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('statusMessage').textContent = 'Đang tổng hợp báo cáo...';
        document.getElementById('progressFill').style.width = '20%';
        
        // Lấy tháng đã chọn
        const monthSelect = document.getElementById('monthSelect');
        const selectedMonth = monthSelect.value;
        
        if (!selectedMonth) {
          showError('Vui lòng chọn tháng/năm báo cáo');
          return;
        }
        
        // Lấy danh sách phân xưởng đã chọn
        const selectedWorkshops = Array.from(
          document.querySelectorAll('input[name="workshops"]:checked')
        ).map(function(checkbox) {
          return checkbox.value;
        });
        
        if (selectedWorkshops.length === 0) {
          showError('Vui lòng chọn ít nhất một phân xưởng');
          return;
        }
        
        // Vô hiệu hóa form
        document.getElementById('monthSelect').disabled = true;
        document.getElementById('consolidateBtn').disabled = true;
        
        // Cập nhật tiến trình
        document.getElementById('progressFill').style.width = '40%';
        
        // Gọi hàm tổng hợp báo cáo
        google.script.run
          .withSuccessHandler(function(result) {
            // Hoàn thành
            document.getElementById('progressFill').style.width = '100%';
            
            if (result.success) {
              document.getElementById('statusMessage').textContent = result.message;
              document.getElementById('statusMessage').style.color = 'green';
              
              // Tự động đóng hộp thoại sau 3 giây
              setTimeout(function() {
                google.script.host.close();
              }, 3000);
            } else {
              showError(result.message);
            }
            
            // Kích hoạt lại form
            document.getElementById('monthSelect').disabled = false;
            document.getElementById('consolidateBtn').disabled = false;
          })
          .withFailureHandler(function(error) {
            showError('Lỗi: ' + error.message);
            
            // Kích hoạt lại form
            document.getElementById('monthSelect').disabled = false;
            document.getElementById('consolidateBtn').disabled = false;
          })
          .consolidateReports({
            monthYear: selectedMonth,
            selectedWorkshops: selectedWorkshops
          });
        
        // Cập nhật tiến trình
        document.getElementById('progressFill').style.width = '60%';
      }
      
      // Hiển thị lỗi
      function showError(message) {
        document.getElementById('statusMessage').textContent = message;
        document.getElementById('statusMessage').style.color = 'red';
      }
      
      // Xử lý lỗi
      function onError(error) {
        showError('Lỗi: ' + error.message);
      }
    </script>
  </body>
</html>